<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.awethumb.repository.dao.MainFeedDAO">
	<resultMap id="mainFeedMap" type="MainFeed">
		<id property="postNo" column="post_no"/>
		<result column="post_no" property="postNo" /> 
		<result column="project_no" property="projectNo" /> 
		<result column="post_content" property="postContent" /> 
		<result column="x_coord" property="xCoord" /> 
		<result column="y_coord" property="yCoord" /> 
		<result column="width" property="width" /> 
		<result column="hight" property="hight" /> 
		<result column="post_public_enabled" property="postPublicEnabled" /> 
		<result column="hashtag_no" property="hashtagNo" /> 
		<result column="user_nickname" property="userNickname" /> 
		<result column="hashtag_content" property="hashtagContent" /> 
		<result column="comment_count" property="commentCount" /> 
		<result column="like_count" property="likeCount" /> 
		<collection property="commentList" resultMap="commentMap"/>
	</resultMap>
	<resultMap id="commentMap" type="Comment">
		<result column="cmt_user_nickname" property="cmtUserNickname" /> 
		<result column="cmt_no" property="cmtNo" /> 
		<result column="cmt_content" property="cmtContent" /> 
		<result column="cmt_reg_dt" property="cmtRegDt" />
		<result column="user_no" property="userNo" />
		<result column="post_no" property="postNo" />
	</resultMap>
	<select id="selectMainFeed" parameterType="FeedPage" resultType="MainFeed">
	<!-- like_tb의 code_value는 1일 경우 게시글, 2일 경우 댓글을 뜻함 -->
		select b.*, u.user_nickname, h.hashtag_content, 
			(select count(c.cmt_no)
		   	   FROM comment_tb c
		  	  WHERE c.post_no = b.post_no
			) as comment_count, 
			(select count(l.post_and_cmt_no)
			   from like_tb l
		  	  where code_value = 1
			 	and b.post_no = l.post_and_cmt_no) as like_count
		  from board_tb b
		 inner join project_tb p
		    on b.project_no = p.project_no
		 inner join user_tb u
		    on u.user_no = p.user_no
		  left outer join hashtag_tb h
		 	on b.post_no = h.post_no
		 order by b.post_no desc
		 limit #{pageIndex} , #{pageCount} 
	</select>
	
	<select id="selectOneMainFeed" parameterType="int" resultMap="mainFeedMap">
		select b.*, c.*, u.*, (select u.user_nickname
								 from user_tb u
								where u.user_no = c.user_no) as cmt_user_nickname
		  from board_tb b
		 inner join project_tb p
		 	on b.project_no = p.project_no
		 inner join user_tb u
		 	on p.user_no = u.user_no
		  left outer join comment_tb c
		    on b.post_no = c.post_no
		 where b.post_no = #{postNo}
	</select>
<!-- 	<insert id="insertMainFeed" parameterType="MainFeed"> -->
<!-- 		insert into board_tb ( -->
<!-- 			no, title, writer, content -->
<!-- 		) values ( -->
<!-- 			seq_MainFeed_no.nextval, #{title}, #{writer}, #{content} -->
<!-- 		) -->
<!-- 	</insert> -->
<!-- 	<update id="updateViewCnt" parameterType="int"> -->
<!-- 		update board_tb  -->
<!-- 		   set view_cnt = view_cnt + 1 -->
<!-- 		 where no = #{no} -->
<!-- 	</update> -->
<!-- 	<update id="updateMainFeed" parameterType="MainFeed"> -->
<!-- 		update board_tb  -->
<!-- 		   set title = #{title},  -->
<!-- 		       content = #{content} -->
<!-- 		 where no = #{no} -->
<!-- 	</update> -->
<!-- 	<delete id="deleteMainFeed" parameterType="int"> -->
<!-- 		delete  -->
<!-- 		  from board_tb  -->
<!-- 		 where no = #{no} -->
<!-- 	</delete> -->
	
 	<!-- 댓글 파트 ============================================= --> 
	<select id="selectComment" parameterType="int" resultType="Comment">
	    select *
	      from comment_tb
	     where post_no = #{postNo}
	     order by cmt_no 
	</select>	
	
	<select id="commentCount" parameterType="int" resultType="int">
		select count(*)
		  from comment_tb
		 where post_no = #{postNo}
	</select>
	<insert id="insertComment" parameterType="Comment">
		insert into comment_tb(
			cmt_content, user_no, post_no
		) values (
			#{cmtContent}, #{userNo}, #{postNo}
		)
	</insert>	
			
	<update id="updateComment" parameterType="comment">
	    update comment_tb
	       set cmt_content = #{cmtContent}
	     where cmt_no = #{cmtNo}
	</update>

	<delete id="deleteComment" parameterType="int">
	    delete 
	      from comment_tb
	     where cmt_no = #{cmtNo}
	</delete>	
</mapper>






















